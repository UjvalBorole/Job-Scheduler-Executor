// pipeline {
//   agent any
//   tools {
//     maven 'maven_3_5_0'
//   }
//   environment {
//     GIT_CREDENTIAL_ID = 'github-credential'
//     DOCKER_HUB_USERNAME = 'boroleujval4'
//   }

//   stages {
//     stage('Checkout') {
//       steps {
//         git branch: 'main',
//             credentialsId: "${GIT_CREDENTIAL_ID}",
//             url: 'https://github.com/UjvalBorole/Job-Scheduler'
//       }
//     }

//     stage('Build') {
//       steps {
//         script {
//           ["Job Management/JobConsumerSvc", 
//            "Job Management/JobService",
//            "Job Scheduling/watcher"].each { service ->
//             dir(service) {
//               sh 'mvn clean install -DskipTests'
//             }
//           }
//         }
//       }
//     }

//     stage('Docker Build') {
//       steps {
//         script {
//           ["job-consumer-svc": "Job Management/JobConsumerSvc",
//            "job_service": "Job Management/JobService",
//            "job_scheduler_svc": "Job Scheduling/watcher"].each { image, service ->
//             dir(service) {
//               sh "docker build -t ${DOCKER_HUB_USERNAME}/${image} ."
//             }
//           }
//         }
//       }
//     }

//     stage('Docker Push') {
//       steps {
//         script {
//           withCredentials([usernamePassword(
//             credentialsId: 'dockerhub-creds',
//             usernameVariable: 'DOCKER_USER',
//             passwordVariable: 'DOCKER_PASS'
//           )]) {
//             sh '''
//               echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
//               docker push ${DOCKER_HUB_USERNAME}/job-consumer-svc
//               docker push ${DOCKER_HUB_USERNAME}/job_service
//               docker push ${DOCKER_HUB_USERNAME}/job_scheduler_svc
//               docker logout
//             '''
//           }
//         }
//       }
//     }
//   }

//   post {
//     failure {
//       echo "❌ Build failed. Check logs."
//     }
//     success {
//       echo "✅ All microservices built and Docker images pushed successfully."
//     }
//     always {
//       sh 'docker logout || true'
//     }
//   }
// }


pipeline {
  agent any
  tools {
    maven 'maven_3_5_0'
  }
  environment {
    GIT_CREDENTIAL_ID = 'github-credential'
    DOCKER_HUB_USERNAME = 'boroleujval4'
    DOCKER_CREDENTIAL_ID = 'dockerhub-creds'
    K8S_DEPLOYMENT_DIR = 'K8s'   // folder where YAML files are stored
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main',
            credentialsId: "${GIT_CREDENTIAL_ID}",
            url: 'https://github.com/UjvalBorole/Job-Scheduler'
      }
    }

    stage('Build Maven Projects') {
      steps {
        script {
          ["Job Management/JobConsumerSvc", 
           "Job Management/JobService",
           "Job Scheduling/watcher"].each { service ->
            dir(service) {
              sh 'mvn clean install -DskipTests'
            }
          }
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        script {
          withCredentials([usernamePassword(
            credentialsId: "${DOCKER_CREDENTIAL_ID}",
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {
            sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'

            def services = [
              "job-consumer-svc": "Job Management/JobConsumerSvc",
              "job_service": "Job Management/JobService",
              "job_scheduler_svc": "Job Scheduling/watcher"
            ]

            services.each { image, service ->
              dir(service) {
                sh "docker build -t ${DOCKER_HUB_USERNAME}/${image}:${BUILD_NUMBER} ."
                sh "docker push ${DOCKER_HUB_USERNAME}/${image}:${BUILD_NUMBER}"
              }
            }

            sh 'docker logout'
          }
        }
      }
    }

    stage('Update Kubernetes YAMLs') {
      steps {
        script {
          sh """
            sed -i 's|image: ${DOCKER_HUB_USERNAME}/job_service:.*|image: ${DOCKER_HUB_USERNAME}/job_service:${BUILD_NUMBER}|' ${K8S_DEPLOYMENT_DIR}/job-service-deployment.yaml
            sed -i 's|image: ${DOCKER_HUB_USERNAME}/job-consumer-svc:.*|image: ${DOCKER_HUB_USERNAME}/job-consumer-svc:${BUILD_NUMBER}|' ${K8S_DEPLOYMENT_DIR}/job-consumer-deployment.yaml
            sed -i 's|image: ${DOCKER_HUB_USERNAME}/job_scheduler_svc:.*|image: ${DOCKER_HUB_USERNAME}/job_scheduler_svc:${BUILD_NUMBER}|' ${K8S_DEPLOYMENT_DIR}/job-scheduler-deployment.yaml
            sed -i 's|imagePullPolicy:.*|imagePullPolicy: Always|' ${K8S_DEPLOYMENT_DIR}/*.yaml
            
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          sh "kubectl apply -f ${K8S_DEPLOYMENT_DIR}/"
        }
      }
    }
  }

  post {
    failure {
      echo "❌ Build failed. Check logs."
    }
    success {
      echo "✅ Build, push, and deployment completed successfully."
    }
  }
}
